#include <Eigen/Core>
#include <eigen-checks/gtest.h>
#include <glog/logging.h>
#include <gtest/gtest.h>
#include <typeinfo>

#include <aslam/cameras/camera.h>
#include <aslam/cameras/camera-factory.h>
#include <aslam/cameras/camera-pinhole.h>
#include <aslam/cameras/camera-generic.h>
#include <aslam/cameras/camera-unified-projection.h>
#include <aslam/cameras/distortion.h>
#include <aslam/cameras/distortion-fisheye.h>
#include <aslam/cameras/distortion-radtan.h>
#include <aslam/cameras/distortion-equidistant.h>
#include <aslam/cameras/distortion-null.h>
#include <aslam/common/entrypoint.h>
#include <aslam/common/memory.h>
#include <aslam/common/numdiff-jacobian-tester.h>
#include <aslam/common/yaml-serialization.h>


aslam::GenericCamera::Ptr setupTestCamera(){
  YAML::Node node = YAML::Load("{type: generic, intrinsics: {rows: 6, cols: 1, data: [15,15,736,464,16,11]}, image_height: 480, image_width: 752,  grid: {rows: 528, cols: 1, data: [-0.73680864697228, -0.48562625042812, 0.47040425448969, -0.65643352034764, -0.49748019131363, 0.56710536288644, -0.57529862830316, -0.51573877806511, 0.63485825274026, -0.4829821466507, -0.53015078136865, 0.69689912830401, -0.38444374137903, -0.54243549487623, 0.74697171540352, -0.28086806363103, -0.55134648666921, 0.78557633777353, -0.1721103096518, -0.55960036817312, 0.810694436426, -0.061722237678026, -0.56287084396511, 0.82423708870083, 0.04989935551493, -0.56445602355111, 0.82395354953788, 0.16062533537446, -0.56247278237593, 0.81106341966712, 0.26901089536198, -0.55820951520686, 0.78487914694497, 0.37276222195738, -0.55095630336118, 0.74665619776975, 0.47204414033422, -0.54025171159243, 0.6966365032767, 0.56275855431752, -0.52822827676352, 0.6358283551163, 0.64784236585731, -0.51131660361745, 0.5646730026002, 0.71758270837233, -0.50356690402212, 0.48113971964348, -0.74482660879238, -0.3909445771263, 0.54073622076792, -0.67189174532953, -0.40740587055911, 0.61853208420583, -0.58631871071313, -0.42173191952584, 0.69164482035272, -0.49253828501389, -0.43359083149535, 0.75458931124072, -0.39178761654292, -0.44396537591327, 0.80585185270855, -0.28515926095472, -0.45196677267159, 0.84522791736465, -0.17454731383209, -0.45740159278634, 0.87196159213036, -0.061229766592886, -0.46096098857752, 0.8853055307026, 0.052817721847604, -0.46193577048946, 0.88533927519406, 0.16604198640003, -0.46064826643592, 0.87191354696547, 0.27681523432077, -0.45693512124914, 0.84533048035486, 0.38346886842054, -0.45093315196242, 0.80598444117334, 0.48430956889612, -0.44281560227242, 0.75455853574111, 0.57829427650963, -0.43228773251534, 0.69188369403603, 0.66344720274583, -0.42005923335663, 0.61918337319454, 0.74000379826004, -0.40493021217735, 0.53705297860334, -0.75990179436045, -0.29680790462239, 0.57832026653182, -0.68243718745857, -0.31039318190435, 0.66176699660902, -0.5953610787439, -0.32079809410701, 0.73663679566949, -0.49982352918459, -0.33047927303425, 0.80059970632533, -0.39729683367312, -0.33831840695849, 0.8530509254824, -0.28865961220064, -0.3445488781225, 0.89328701931054, -0.17603626334314, -0.34914465656895, 0.92038537731623, -0.060806842321716, -0.35179614609808, 0.93409956616915, 0.055267105910384, -0.35278842202231, 0.93406952433494, 0.17053574142323, -0.35186586124566, 0.92038468945712, 0.28323547455551, -0.34918832863142, 0.89322179614075, 0.39168807991485, -0.34473134068351, 0.85307722440772, 0.49450477832578, -0.33842753159012, 0.80058218196184, 0.58997181479829, -0.33060847079331, 0.73663511780481, 0.67706344707325, -0.32104402890598, 0.66220527039665, 0.75420409067053, -0.31050005146438, 0.57858958481505, -0.76812264873815, -0.2009072021158, 0.60796701607364, -0.68992177844774, -0.20759326624913, 0.69347889328481, -0.60163662553573, -0.21557203106791, 0.76913072376238, -0.50503800010051, -0.22209778457673, 0.83403188940267, -0.40098308456185, -0.22779772730831, 0.88731097216727, -0.29110727643508, -0.23216340458488, 0.92809304877157, -0.17695562751952, -0.23540952216918, 0.95565111979281, -0.060335199665269, -0.23746618039481, 0.9695202302428, 0.05721341853462, -0.23822716645767, 0.96952279081058, 0.17387675788453, -0.23779376813896, 0.95562597123657, 0.28791894946238, -0.23611990382639, 0.92808947281902, 0.39787809969711, -0.23311086710279, 0.88732876737994, 0.50185275913732, -0.22902512950122, 0.83408111008655, 0.59862251876608, -0.2236545334909, 0.76917470686127, 0.686773878932, -0.217374749619, 0.69360641392995, 0.76487464264496, -0.2098064824764, 0.60905502292455, -0.77428391501926, -0.096920937778581, 0.62537248961125, -0.69399517455981, -0.10241840987289, 0.71265781901752, -0.60542381066016, -0.1065626786924, 0.78873722176377, -0.50784199110286, -0.11044193335186, 0.85434132021703, -0.40303941206181, -0.11355023114121, 0.90811099394989, -0.29224781379666, -0.11618984981496, 0.94925820203517, -0.17730850393948, -0.11818018158758, 0.97703384747442, -0.05979344668954, -0.11945876646463, 0.99103700579127, 0.058599484147317, -0.12012550929984, 0.99102773042591, 0.17602867679666, -0.12016568006294, 0.97702308789518, 0.29103556491225, -0.11945729715765, 0.94922508084858, 0.40164166306628, -0.11813458739915, 0.90814546948679, 0.50654658835759, -0.1161009061801, 0.85436007245625, 0.6039769086833, -0.11342935826947, 0.78888888600357, 0.69272882575311, -0.11015330733111, 0.71273629264598, 0.77216599030945, -0.10647805391823, 0.62643603619461, -0.77396376555512, 0.0048696532889419, 0.63321116231837, -0.69532114040719, 0.0049491471279569, 0.71868213950643, -0.6060652488246, 0.0038874421214649, 0.79540543244369, -0.50848113419124, 0.003152973956816, 0.8610673579499, -0.40327231980335, 0.0022351597728664, 0.91507728643061, -0.29230885986179, 0.0015531920751465, 0.95632270601543, -0.17701358969952, 0.00086524594042629, 0.98420802699996, -0.059243790234189, 0.00025344831443789, 0.99824351191613, 0.059339538824344, -0.00027720213746297, 0.99823781850373, 0.17709595048397, -0.00069804683999123, 0.98419334332883, 0.29231191822824, -0.0010481250720005, 0.95632245811523, 0.40325813838092, -0.0012406613127543, 0.91508542474955, 0.50831404482585, -0.0013552128798042, 0.86117071201408, 0.60598479889314, -0.0014148774052128, 0.79547496606265, 0.6950823121567, -0.0012685629584321, 0.71892904383876, 0.77370050087794, -0.0012419875981948, 0.63355030771679, -0.77153798942826, 0.10970186726151, 0.62665351765417, -0.69311613540803, 0.1118803014625, 0.71209045842625, -0.604108995172, 0.11444239959637, 0.78864140084509, -0.50661896975475, 0.11649391495788, 0.85426365207846, -0.40182328522893, 0.11831132656416, 0.90804211215915, -0.29110170929508, 0.11935129563119, 0.94921813250519, -0.17623186886245, 0.11996582536782, 0.97701101792204, -0.058752522305074, 0.12001097294189, 0.99103254613374, 0.059571368700493, 0.11962138434628, 0.99103076462753, 0.17700105394968, 0.11879071655417, 0.97701555389935, 0.29187824353126, 0.11747552529389, 0.9492136703135, 0.40250018154614, 0.11564632906167, 0.90808564047114, 0.50725033043003, 0.11335879231846, 0.85431076692426, 0.60465882495889, 0.1106937241044, 0.78875509814088, 0.69341318020326, 0.10752469873626, 0.71247217537394, 0.77232015803405, 0.10430138841494, 0.62661215585798, -0.7656078789582, 0.20993439712327, 0.60808891174039, -0.68737155863899, 0.21764189045682, 0.69293026192582, -0.59940805960742, 0.22351531783455, 0.7686032011194, -0.50252403441558, 0.22855540107114, 0.83380574684749, -0.39857822204048, 0.2323575135924, 0.88721214305949, -0.28889653735469, 0.23535155265392, 0.92798083890125, -0.17476619038261, 0.23722320635366, 0.95560553005225, -0.058278373328452, 0.23813513623158, 0.9694819689371, 0.059218573121852, 0.2378651268003, 0.96949128002767, 0.17571759366789, 0.23660479581708, 0.95558437506686, 0.28969970055527, 0.23418834134853, 0.928024732577, 0.39944328480979, 0.23083339548927, 0.8872209452821, 0.5033548659632, 0.22643684664922, 0.83388262566786, 0.5999411149941, 0.22111542760576, 0.76888141232206, 0.68790295561068, 0.21487662608973, 0.69326586474626, 0.76599792517135, 0.20781648409948, 0.60832514954564, -0.75410132535918, 0.30946319207273, 0.57927862367231, -0.67875793924457, 0.3196529274437, 0.66114269707011, -0.59168296071542, 0.32886701053214, 0.73604195762381, -0.4964411340665, 0.33679506446137, 0.80007204985628, -0.39376048426488, 0.34321427128352, 0.85273480345229, -0.28538753621772, 0.34801125331154, 0.89299614878235, -0.17278224378662, 0.35112971959241, 0.92024682354845, -0.057695285294946, 0.35265864829895, 0.9339716975555, 0.05820461615991, 0.35261796180349, 0.93395545700597, 0.17327263597523, 0.35079582670858, 0.92028195765539, 0.28574366554384, 0.3475384625288, 0.89306638872185, 0.39408542818382, 0.34251048305806, 0.85286765930507, 0.4966529861426, 0.33610484529866, 0.80023080690661, 0.59193836316241, 0.32811535000228, 0.7361720527903, 0.67862715121686, 0.31893775329357, 0.66162217250885, 0.75581104257595, 0.30750839926579, 0.57809017661715, -0.74114388364916, 0.40309551713724, 0.53686101347863, -0.66677994185866, 0.41705098254364, 0.61763499503699, -0.58141962865961, 0.42982615001232, 0.69079714545944, -0.48796906872363, 0.44008472760343, 0.75379812980612, -0.38702146528386, 0.4487073392926, 0.80552846571334, -0.2809813198152, 0.45533552773549, 0.84481894811655, -0.17026852925844, 0.45969852848374, 0.87159961613923, -0.057129731763082, 0.46204421296045, 0.88501488067627, 0.056598013366457, 0.46196320321514, 0.885091330744, 0.1696744941614, 0.45990509921984, 0.87160648560154, 0.28017934300592, 0.45548919257785, 0.84500244449206, 0.38648270316358, 0.44926185348741, 0.80547806125085, 0.48726725115971, 0.44062136227481, 0.75393861889039, 0.58063944526348, 0.4304488392141, 0.69106557678946, 0.66581113843193, 0.41769853886104, 0.618242232926, 0.74034333257333, 0.40593743576122, 0.53582324339452, -0.71839602841265, 0.49208827207521, 0.49168717580079, -0.65161981738977, 0.50756849636788, 0.56370722461201, -0.56888392603689, 0.52299441246673, 0.6347030197072, -0.47787677873614, 0.53748799482727, 0.69479525024379, -0.37924893367517, 0.54794678887351, 0.74560348904056, -0.27495355391929, 0.55606338514756, 0.7843430721855, -0.16689194396882, 0.56201382227019, 0.81011575877498, -0.057003011163135, 0.56425143776271, 0.82363278935522, 0.054792373152076, 0.56471734269075, 0.8234634896027, 0.16492652227631, 0.5621599106741, 0.81041685389726, 0.27284847937779, 0.55714360883347, 0.784311613096, 0.37691390789235, 0.54846959483533, 0.74640271273521, 0.47473752945377, 0.53951402193883, 0.69537680307839, 0.56679109341873, 0.52456138509254, 0.63528199226092, 0.64837920155748, 0.51273674936996, 0.56276588101378, 0.73190527205887, 0.47467946237535, 0.48887020847203]}}");
  aslam::Camera::Ptr camera = aslam::createCamera(node);
  EXPECT_TRUE(camera.get() != nullptr);
  EXPECT_EQ(typeid(*camera.get()), typeid(aslam::GenericCamera));
  return std::dynamic_pointer_cast<aslam::GenericCamera>(camera);
}

TEST(TestGenericCamera, ReadFromYAML) {
  aslam::GenericCamera::Ptr gencam = setupTestCamera();
  EXPECT_EQ(480u, gencam->imageHeight());
  EXPECT_EQ(752u, gencam->imageWidth());
  EXPECT_EQ(15, gencam->calibrationMinX());
  EXPECT_EQ(15, gencam->calibrationMinY());
  EXPECT_EQ(736, gencam->calibrationMaxX());
  EXPECT_EQ(464, gencam->calibrationMaxY());
  EXPECT_EQ(16, gencam->gridWidth());
  EXPECT_EQ(11, gencam->gridHeight());
  EXPECT_EQ(-0.73680864697228, gencam->firstGridValue().x());
  EXPECT_EQ(-0.48562625042812, gencam->firstGridValue().y());
  EXPECT_EQ(0.47040425448969, gencam->firstGridValue().z());
  EXPECT_EQ(0.73190527205887, gencam->lastGridValue().x());
  EXPECT_EQ(0.47467946237535, gencam->lastGridValue().y());
  EXPECT_EQ(0.48887020847203, gencam->lastGridValue().z());
  // To keep the yaml simple, if there is no id, a random id is created.
  EXPECT_TRUE(gencam->getId().isValid());
  EXPECT_EQ(0u, gencam->getLineDelayNanoSeconds());
  EXPECT_EQ(aslam::NullDistortion(), gencam->getDistortion());
}


TEST(TestGenericCamera, Constructors) {
  aslam::Distortion::UniquePtr distortion;
  Eigen::Matrix< double, 6+3*4*4, 1 > intrinsics;
  intrinsics << 1, 1, 299, 199, 4, 4;
  for(int i = 6; i < 6+3*4*4; i++) intrinsics(i) = (i)*(i);

  aslam::GenericCamera g();

  distortion.reset(new aslam::NullDistortion());
  aslam::GenericCamera g1(intrinsics, 300, 200, distortion);

  Eigen::Vector4d distortion_params = {1,2,3,4};
  distortion.reset(new aslam::EquidistantDistortion(distortion_params));
  aslam::GenericCamera g2(intrinsics, 300, 200, distortion);

  aslam::GenericCamera g3(intrinsics, 200, 300);

}

TEST(TestGenericCamera, BackProject3) {
  aslam::GenericCamera::Ptr gencam = setupTestCamera();

  Eigen::Vector3d direction;
  Eigen::Vector2d notInCalibratedArea = Eigen::Vector2d(9, 14);
  bool backProjectWorked = gencam->backProject3(notInCalibratedArea, &direction);
  EXPECT_EQ(backProjectWorked, false);
  // Test that projection at gridpoints is equal to vector at gridpoint
  Eigen::Vector2d gridpoint = Eigen::Vector2d(5,3);
  Eigen::Vector2d keypoint = gencam->transformGridPointToImagePixel(gridpoint);
  backProjectWorked = gencam->backProject3(keypoint, &direction);
  EXPECT_EQ(backProjectWorked, true);

  Eigen::Vector3d solution = gencam->gridAccess(gridpoint);
  //EXPECT_DOUBLE_EQ(direction.x(), solution.x());
  //EXPECT_DOUBLE_EQ(direction.y(), solution.y());
  //EXPECT_DOUBLE_EQ(direction.z(), solution.z());
  EXPECT_LT((direction - solution).norm(), 1e-3);
}

TEST(TestGenericCamera, BackProject3WithJacobian) {
  aslam::GenericCamera::Ptr gencam = setupTestCamera();

  Eigen::Vector3d direction;
  Eigen::Matrix<double, 3, 2> jacobian;
  Eigen::Vector2d notInCalibratedArea = Eigen::Vector2d(9, 14);
  bool backProjectWorked = gencam->backProject3WithJacobian(notInCalibratedArea, &direction, &jacobian);
  EXPECT_EQ(backProjectWorked, false);
  
  // Test that projection at gridpoints is equal to vector at gridpoint
  Eigen::Vector2d gridpoint = Eigen::Vector2d(5,3);
  Eigen::Vector2d keypoint = gencam->transformGridPointToImagePixel(gridpoint);
  backProjectWorked = gencam->backProject3WithJacobian(keypoint, &direction, &jacobian);
  EXPECT_EQ(backProjectWorked, true);

  Eigen::Vector3d solution = gencam->gridAccess(gridpoint);
  //EXPECT_DOUBLE_EQ(direction.x(), solution.x());
  //EXPECT_DOUBLE_EQ(direction.y(), solution.y());
  //EXPECT_DOUBLE_EQ(direction.z(), solution.z());
  EXPECT_LT((direction - solution).norm(), 1e-3);

  // TODO(beni) test jacobian
}

TEST(TestGenericCamera, BackProjectAndProject) {
  aslam::GenericCamera::Ptr gencam = setupTestCamera();

  // check for all calibrated pixels
  for(int i = gencam->calibrationMinX(); i < gencam->calibrationMaxX(); i += 1){
    for(int j = gencam->calibrationMinY(); j < gencam->calibrationMaxY(); j += 1){

      Eigen::Vector3d direction;
      Eigen::Vector2d keypoint = Eigen::Vector2d(i, j);
      bool backProjectWorked = gencam->backProject3(keypoint, &direction);
      EXPECT_EQ(backProjectWorked, true);

      Eigen::Vector2d out_keypoint;
      Eigen::Matrix<double, 2, 3>* out_jacobian_point = nullptr;
      gencam->project3Functional(direction, &out_keypoint, out_jacobian_point);

      // TODO(beni) check output of gencam->project3Functional

      EXPECT_LT(fabs(out_keypoint.x() - keypoint.x()), 1e-5);
      EXPECT_LT(fabs(out_keypoint.y() - keypoint.y()), 1e-5);
      if(fabs(out_keypoint.x() - keypoint.x()) > 1e-5 || !backProjectWorked){
        LOG(ERROR) << i << " " << j;
      }
    }
  }
}


TEST(TestGenericCamera, gridPixelTransformation) {
  aslam::GenericCamera::Ptr gencam = setupTestCamera();
  
  // Test that grid to pixel is the inverse of pixel to grid
  // starting from pixel
  Eigen::Vector2d a = Eigen::Vector2d(21.2, 5.3);
  Eigen::Vector2d a_grid = gencam->transformImagePixelToGridPoint(a);
  Eigen::Vector2d a_pixel = gencam->transformGridPointToImagePixel(a_grid);
  EXPECT_DOUBLE_EQ(a.x(), a_pixel.x());
  EXPECT_DOUBLE_EQ(a.y(), a_pixel.y());

  // starting from grid
  Eigen::Vector2d b = Eigen::Vector2d(12.4, 2.1);
  Eigen::Vector2d b_pixel = gencam->transformGridPointToImagePixel(b);
  Eigen::Vector2d b_grid = gencam->transformImagePixelToGridPoint(b_pixel);
  EXPECT_DOUBLE_EQ(b.x(), b_grid.x());
  EXPECT_DOUBLE_EQ(b.y(), b_grid.y());

  // pixel (15, 15) is gridpoint (1,1), known from camera intrinsics
  Eigen::Vector2d c = Eigen::Vector2d(15, 15);
  Eigen::Vector2d c_grid = gencam->transformImagePixelToGridPoint(c);
  EXPECT_DOUBLE_EQ(c_grid.x(), 1);
  EXPECT_DOUBLE_EQ(c_grid.y(), 1);
  Eigen::Vector2d c_pixel = gencam->transformGridPointToImagePixel(c_grid);
  EXPECT_DOUBLE_EQ(c.x(), c_pixel.x());
  EXPECT_DOUBLE_EQ(c.y(), c_pixel.y());
}

TEST(TestGenericCamera, compareWithOriginalImplementation) {
  aslam::GenericCamera::Ptr gencam = setupTestCamera();

  Eigen::Vector2d pixel = Eigen::Vector2d(50, 70);
  Eigen::Vector3d direction;
  bool backProjectWorked = gencam->backProject3(pixel, &direction);
  EXPECT_EQ(backProjectWorked, true);

  // solution computed with original generic camera calibration with same calibration file
  EXPECT_DOUBLE_EQ(direction.x(), -0.62911016602490222);
  EXPECT_DOUBLE_EQ(direction.y(), -0.31968318994319406);
  EXPECT_DOUBLE_EQ(direction.z(), 0.70853585447164469);
}
ASLAM_UNITTEST_ENTRYPOINT
